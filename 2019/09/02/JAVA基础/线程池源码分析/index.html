

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/crazy_ll/img/favicon.png">
  <link rel="icon" type="image/png" href="/crazy_ll/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="ä»£ç æŒ–æ˜æœº">
  <meta name="author" content="HY">
  <meta name="keywords" content>
  <title>çº¿ç¨‹æ± å…¨è§£æ - HY&#39;S ä»£ç æŒ–æ˜ç«™</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/crazy_ll/lib/hint/hint.min.css">

  
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css">
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">

<link rel="stylesheet" href="/crazy_ll/css/main.css">

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script src="/crazy_ll/js/utils.js"></script>
  <script src="/crazy_ll/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/crazy_ll/">&nbsp;<strong>ä»£ç ğŸ”</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/crazy_ll/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/crazy_ll/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/crazy_ll/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/crazy_ll/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/crazy_ll/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/crazy_ll/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2019-09-02 00:00" pubdate>
      2019å¹´9æœˆ2æ—¥ å‡Œæ™¨
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      7.5k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      91
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">çº¿ç¨‹æ± å…¨è§£æ</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å¹³æ—¶åœ¨å¤„ç†ä¸šåŠ¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨çº¿ç¨‹æ± æ¥è¿›è¡Œå¤„ç†ï¼Œé‚£æˆ‘ä»¬åº”è¯¥é€‰æ‹©ä»€ä¹ˆæ–¹å¼åˆ›å»ºçº¿ç¨‹æ± ï¼Œåœ¨é˜¿é‡Œå¼€å‘è§„èŒƒä¸­æ˜¯å»ºè®®ç¨‹åºå‘˜æ˜¾ç¤ºçš„åˆ›å»ºThreadPoolSizeï¼Œé‚£ä¹ˆçº¿ç¨‹æ± åº”è¯¥å¦‚ä½•é…ç½®ï¼Ÿçº¿ç¨‹åœ¨çº¿ç¨‹æ± é‡Œé¢æ˜¯æ€ä¹ˆå¤ç”¨çš„ï¼Ÿçº¿ç¨‹æ± æ˜¯æ€ä¹ˆè¿ä½œçš„ï¼Ÿçº¿ç¨‹æ± è¯¥æ€ä¹ˆå…³é—­æ¯”è¾ƒåˆé€‚ï¼Ÿ<br>æ¥ä¸‹æ¥å°†ä¼šä»<br><strong>çº¿ç¨‹æ± çš„åˆ›å»º â†’ çº¿ç¨‹æ± çš„æ‰§è¡Œè¿‡ç¨‹ â†’  çº¿ç¨‹æ± çš„å…³é—­ â†’  çº¿ç¨‹æ± çš„å‚æ•°å¦‚ä½•è®¾å®š</strong><br>è¿™å‡ ä¸ªæ–¹é¢æ¥è§£æçº¿ç¨‹æ± </p>
<h1 id="çº¿ç¨‹æ± çš„åˆ›å»º"><a href="#çº¿ç¨‹æ± çš„åˆ›å»º" class="headerlink" title="çº¿ç¨‹æ± çš„åˆ›å»º"></a>çº¿ç¨‹æ± çš„åˆ›å»º</h1><p>åˆ›å»ºæ— éå°±æ˜¯newä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆä¼ å…¥çš„å‚æ•°çš„è®¾ç½®å°±å¾ˆé‡è¦ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¦è®¾ç½®ä»€ä¹ˆæ ·çš„å‚æ•°æ¥å®Œæˆä»»åŠ¡</p>
<ul>
<li>æ‰€ä»¥å¸¦ç€é—®é¢˜æ¥çœ‹çº¿ç¨‹æ± çš„æ„é€ æ–¹æ³•</li>
<li>çº¿ç¨‹æ± ä¸­çš„å‚æ•°æœ‰å“ªäº›ï¼Ÿ</li>
<li>è¿™äº›å‚æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</li>
<li>å‚æ•°çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ul>
<hr>
<p>åœ¨Executorsé‡Œé¢ï¼Œæœ‰4ä¸ªå·²ç»è®¾è®¡å¥½çš„çº¿ç¨‹æ± å®ç°æ–¹æ³•ï¼š</p>
<ul>
<li><em>newCachedThreadPool</em></li>
</ul>
<p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163417.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<ul>
<li><em>newFixedThreadPool</em></li>
</ul>
<p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163629.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<a id="more"></a>
<ul>
<li><em>newSingleThreadExecutor</em></li>
</ul>
<p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163638.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<ul>
<li><em>newScheduledThreadPool</em></li>
</ul>
<p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163647.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163656.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163708.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p>æœ€åä¸€ä¸ªnewScheduledThreadPoolè°ƒç”¨äº†superçš„æ„é€ æ–¹æ³•ï¼Œçœ‹è¿™ä¸ªç±»ç»§æ‰¿å…³ç³»ï¼Œä¾æ—§æ˜¯ThreadPoolExecutorï¼Œé‚£ä¹ˆä¸Šè¿°å°±æ˜¯æºç æä¾›çš„ä¸€äº›åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯è°ƒç”¨äº†ThreadPoolExecutorçš„æ„é€ æ–¹æ³•ï¼Œä»…ä»…åªæ˜¯åœ¨æ–¹æ³•å‚æ•°ä¸Šåšäº†æ”¹å˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦äº†è§£çº¿ç¨‹æ± å°±éœ€è¦äº†è§£è¿™äº›å‚æ•°åœ¨çº¿ç¨‹æ± ä¸­æ˜¯èµ·åˆ°äº†ä»€ä¹ˆä½œç”¨ã€‚<br>å…ˆæ¥çœ‹çœ‹çº¿ç¨‹æ± çš„å…¨å‚æ„é€ æ–¹æ³•</p>
<p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163714.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p>å…¶ä¸­æœ‰ä¸ªaccå‚æ•°ï¼Œè·å–äº†SecurityManagerï¼Œè¿™æ˜¯å¯¹è¿è¡Œä»£ç çš„æƒé™æ§åˆ¶ï¼Œå¯ä»¥è‡ªå·±å»äº†è§£ä¸€ä¸‹ã€‚</p>
<ol>
<li>corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸ä¼šç»“æŸçš„çº¿ç¨‹ï¼Œä¸€ç›´ä¿æŒå·¥ä½œ</li>
<li>maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œçº¿ç¨‹æ± å¯ä»¥åˆ›å»ºçš„æœ€å¤§çš„çº¿ç¨‹æ•°é‡</li>
<li>keepAliveTimeï¼šçº¿ç¨‹å­˜æ´»æ—¶é—´ï¼Œä»…å¯¹éæ ¸å¿ƒçº¿ç¨‹æœ‰æ•ˆ</li>
<li>unitï¼šå­˜æ´»æ—¶é—´å•ä½</li>
<li>workQueueï¼šä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥çœ‹åˆ°ç±»å‹ä¸ºRunnableï¼Œä¹Ÿå°±æ˜¯éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡çš„é˜Ÿåˆ—</li>
<li>threadFactoryï¼šçº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹</li>
<li>rejectedExecutionHandlerï¼šæ‹’ç»ç­–ç•¥ï¼Œå½“çº¿ç¨‹æ± æ— æ³•å¤„ç†ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡</li>
</ol>
<p>æ¥ä¸‹æ¥äº†è§£ä¸€ä¸‹BLockingQueueï¼ŒThreadFactoryï¼ŒRejectExecutionHandlerï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆ</p>
<h2 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h2><p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163722.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p>ä¸€ä¸ªBlockingQueueçš„åŸºæœ¬æ–¹æ³•å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨è·å–å’Œæ·»åŠ çš„æ—¶å€™å¦‚æœé˜Ÿåˆ—ä¸ºç©ºæˆ–è€…æ»¡çš„æ—¶å€™ä¼šå‘ç”Ÿç­‰å¾…ï¼Œåœ¨çº¿ç¨‹æ± ä¸­èµ·åˆ°äº†ä»»åŠ¡è·å–çš„ä½œç”¨ï¼Œæ˜¯ä¸€ç§FIFOé˜Ÿåˆ—</p>
<h2 id="ThreadFactory"><a href="#ThreadFactory" class="headerlink" title="ThreadFactory"></a>ThreadFactory</h2><p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163728.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p>çº¿ç¨‹å·¥å‚å°±å¾ˆå¥½ç†è§£äº†ï¼Œå¯ä»¥è‡ªå®šä¹‰å®ç°ï¼Œåœ¨çº¿ç¨‹æ± çš„æ„é€ æ–¹æ³•ä¸­ï¼Œå¦‚æœä¸ä¼ è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå°±æœ‰é»˜è®¤çš„ThreadFactory</p>
<p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163735.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p>å¯¹çº¿ç¨‹çš„åå­—ï¼Œæ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹è¿˜æœ‰ä¼˜å…ˆçº§è¿›è¡Œäº†è®¾ç½®ï¼Œå¯ä»¥è‡ªå·±å®ç°ThreadFactory</p>
<h2 id="RejectExecutionHandler"><a href="#RejectExecutionHandler" class="headerlink" title="RejectExecutionHandler"></a>RejectExecutionHandler</h2><p>æ‹’ç»ç­–ç•¥æ˜¯å½“çº¿ç¨‹æ± ä¸èƒ½å†ç»§ç»­æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œå¯¹è¿™ä¸ªæ–°çš„ä»»åŠ¡æ‰€æ‰§è¡Œçš„æ‹’ç»ç­–ç•¥<br>å·²ç»æä¾›çš„æ‹’ç»ç­–ç•¥æ€»å…±æœ‰4ç§ï¼š</p>
<h3 id="AbortPolicy"><a href="#AbortPolicy" class="headerlink" title="AbortPolicy"></a>AbortPolicy</h3><p>ç›´æ¥æŠ›å‡ºäº†æ‹’ç»çš„é”™è¯¯<br><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163746.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<h3 id="CallerRunsPolicy"><a href="#CallerRunsPolicy" class="headerlink" title="CallerRunsPolicy"></a>CallerRunsPolicy</h3><p>è°ƒç”¨è€…æ‰§è¡Œï¼Œå¦‚æœçº¿ç¨‹æ± æ²¡æœ‰è¢«å…³é—­ï¼Œåˆ™ä½¿ç”¨è°ƒç”¨è€…çš„çº¿ç¨‹æ¥å¤„ç†è¿™æ¡ä»»åŠ¡ï¼Œå¦åˆ™å°±æŠ›å¼ƒè¿™æ¡ä»»åŠ¡<br><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163753.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<h3 id="DiscardOldestPolicy"><a href="#DiscardOldestPolicy" class="headerlink" title="DiscardOldestPolicy"></a>DiscardOldestPolicy</h3><p>æŠ›å¼ƒæœ€è€çš„ä¸€æ¡ä»»åŠ¡ï¼Œæœ€è€çš„ä¸€æ¡ä»»åŠ¡å°±æ˜¯é˜Ÿåˆ—ä¸­çš„é˜Ÿå¤´çš„æ•°æ®<br><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163759.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<h3 id="DiscardPolicy"><a href="#DiscardPolicy" class="headerlink" title="DiscardPolicy"></a>DiscardPolicy</h3><p>ç›´æ¥æŠ›å¼ƒä»»åŠ¡ï¼Œä¸åšä»»ä½•å¤„ç†<br><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163806.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<h1 id="çº¿ç¨‹æ± çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#çº¿ç¨‹æ± çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="çº¿ç¨‹æ± çš„æ‰§è¡Œè¿‡ç¨‹"></a>çº¿ç¨‹æ± çš„æ‰§è¡Œè¿‡ç¨‹</h1><p>å¯¹äºçº¿ç¨‹æ± æ‰§è¡Œè¿‡ç¨‹ï¼Œè‡ªå·±ç¬¬ä¸€æ¬¡æ¥è§¦ä¹‹å‰æœ‰å¾ˆå¤šç–‘é—®ï¼š</p>
<ul>
<li>çº¿ç¨‹æ± çš„æ‰§è¡Œæ–¹å¼æœ‰å“ªäº›ï¼Ÿ</li>
<li>è°ƒç”¨æ‰§è¡Œäº†ä»¥åçº¿ç¨‹æ± æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ</li>
<li>æ–°å¢äº†ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡çš„å¤„ç†åˆæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</li>
<li>çº¿ç¨‹åœ¨çº¿ç¨‹æ± æ˜¯æ€ä¹ˆåšåˆ°å¤ç”¨çš„ï¼Ÿ</li>
<li>éæ ¸å¿ƒçº¿ç¨‹çš„é”€æ¯æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ</li>
<li>å…³é—­äº†çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± æ˜¯æ€ä¹ˆå“åº”å…³é—­çš„ï¼Ÿ</li>
</ul>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥é€šè¿‡æºç çš„é˜…è¯»æ¥ä¸€ä¸ªä¸ªè§£å†³ä¸Šé¢çš„é—®é¢˜</p>
<p>çº¿ç¨‹æ± çš„ä½¿ç”¨ä¸€èˆ¬æ˜¯execute(Runnable command)æˆ–è€…submit(Runnable task, T result)ï¼Œexecuteå’Œsubmitçš„ä¸»è¦åŒºåˆ«åœ¨äºsubmitæ˜¯æœ‰ä¸€ä¸ªFutureçš„è¿”å›å€¼ï¼Œå¯ä»¥ç­‰å¾…è·å–åˆ°çº¿ç¨‹å¤„ç†çš„ç»“æœï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡future.get()æ¥å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ï¼Œè€Œexecuteåˆ™åªæ˜¯æ‰§è¡Œï¼Œå…ˆçœ‹ä¸€ä¸‹ä»£ç <br><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163813.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p>ä½¿ç”¨äº†submitæ–¹æ³•ï¼Œéšä¾¿å†™äº†ä¸€ä¸ªç±»å®ç°äº†Callableæ¨¡æ‹Ÿè®¡ç®—è¿”å›äº†ä¸€ä¸ªå€¼ï¼Œsubmitæ–¹æ³•çš„è°ƒç”¨æµç¨‹å¦‚ä¸‹</p>
<pre><code class="hljs undefined"><span class="hljs-keyword">public</span> &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) &#123;                      <span class="hljs-comment">//æ–¹æ³•1</span>
    <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">NullPointerException</span>();
    RunnableFuture&lt;T&gt; ftask = <span class="hljs-keyword">new</span><span class="hljs-type">TaskFor</span>(task);
    execute(ftask);
    <span class="hljs-keyword">return</span> ftask;
&#125;

protected &lt;T&gt; RunnableFuture&lt;T&gt; <span class="hljs-keyword">new</span><span class="hljs-type">TaskFor</span>(Callable&lt;T&gt; callable) &#123;   <span class="hljs-comment">//æ–¹æ³•2</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">FutureTask</span>&lt;T&gt;(callable);
&#125;

<span class="hljs-keyword">public</span> FutureTask(Callable&lt;V&gt; callable) &#123;                            <span class="hljs-comment">//æ–¹æ³•3</span>
    <span class="hljs-keyword">if</span> (callable == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">NullPointerException</span>();
    <span class="hljs-built_in">this</span>.callable = callable;
    <span class="hljs-built_in">this</span>.state = NEW;       <span class="hljs-comment">// ensure visibility of callable</span>
&#125;</code></pre>

<p><strong>æ–¹æ³•3</strong>å°±æ˜¯å®ä¾‹äº†ä¸€ä¸ªFutureTaskï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ªcallableå’Œstateï¼Œåœ¨<strong>æ–¹æ³•1</strong>ä¸­å¯ä»¥çœ‹åˆ°çº¿ç¨‹æ± çš„çœŸæ­£æ‰§è¡Œæ–¹æ³•å°±æ˜¯execute(Runnable command)ï¼Œé‚£ä¹ˆä½¿ç”¨äº†submitå’Œexecuteæœ€ç»ˆéƒ½æ˜¯èµ°çš„executeæ–¹æ³•æ¥è¿›è¡Œä»»åŠ¡çš„æ‰§è¡Œå¤„ç†</p>
<p>å¤§è‡´çœ‹ä¸€ä¸‹æ‰§è¡Œæ–¹æ³•<br><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163820.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p>åœ¨1365è¡Œå¯ä»¥çœ‹åˆ°æœ‰ä¸ªctl.get()ï¼Œé‚£ä¹ˆè¿™ä¸ªctlçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Œè€Œä¸”åé¢éƒ½æœ‰é€šè¿‡ctlè·å–çš„å€¼æ¥è¿›è¡Œåˆ¤æ–­ï¼Œç®€å•çš„åˆ†æä¸€ä¸‹ctlçš„æ„æˆ</p>
<h2 id="ctl"><a href="#ctl" class="headerlink" title="ctl"></a>ctl</h2><p><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163828.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p>ctlæ˜¯ä¸€ä¸ªAutomicIntegerçš„å€¼ï¼Œç¬¬395è¡Œå°±æ˜¯ç”Ÿæˆctlçš„æ–¹æ³•ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªå‚æ•°</p>
<ol>
<li><p>rsï¼šRunStateï¼ŒæŒ‡çš„æ˜¯å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œå…¶ä¸­åªæœ‰runningçŠ¶æ€æ˜¯å°äº0çš„</p>
</li>
<li><p>wcï¼šWorkerCountï¼ŒæŒ‡çš„æ˜¯å½“å‰çº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹çš„æ•°é‡</p>
<p>åœ¨381è¡Œï¼Œctlçš„é»˜è®¤å€¼ä¸º RUNNING | 0 = 11100000 00000000 00000000 00000000ï¼Œå…¶ä¸­å‰3ä½ä»£è¡¨çš„æ˜¯Runstateï¼Œå‰©ä½™ä»£è¡¨çš„éƒ½æ˜¯WorkerCountï¼ˆè´Ÿæ•°å­˜å‚¨çš„æ˜¯è¡¥ç ï¼Œæ‰€ä»¥å‰3ä½æ˜¯111ï¼‰<br>ctlä¸»è¦ä½œç”¨å°±æ˜¯å­˜å‚¨å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€å’Œçº¿ç¨‹æ•°é‡ï¼Œé€šè¿‡ç®€å•çš„æ–¹å¼æ¥è·å–éœ€è¦çš„æ•°æ®å’Œåˆ¤æ–­çŠ¶æ€ï¼Œå…¶ä¸­CAPACITYä»£è¡¨çš„æ˜¯çº¿ç¨‹æ± ä¸­æœ€å¤§çº¿ç¨‹æ•°</p>
</li>
</ol>
<p>ç”±äºctlè¡¨ç¤ºäº†çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œé¡ºä¾¿çœ‹ä¸€ä¸‹çº¿ç¨‹æ± çš„çŠ¶æ€æœ‰å“ªäº›</p>
<h2 id="çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€"><a href="#çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€" class="headerlink" title="çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€"></a>çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€</h2><ol>
<li>RUNNINGï¼šè¿è¡Œä¸­çŠ¶æ€ï¼Œæ¥å—ä»»åŠ¡å¹¶ä¸”èƒ½æ­£å¸¸å¤„ç†</li>
<li>SHUTDOWNï¼šå…³é—­çŠ¶æ€ï¼Œä¸å†æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä»ç„¶å¤„ç†é˜Ÿåˆ—ä¸­å·²ç»å­˜åœ¨çš„æ•°æ®ï¼Œå½“é˜Ÿåˆ—ä¸­æ•°æ®ä¸ºç©ºçš„æ—¶å€™å¯ä»¥åˆ‡æ¢åˆ°STOP</li>
<li>STOPï¼šåœæ­¢çŠ¶æ€ï¼Œåœ¨SHUTDOWNçš„åŸºç¡€ä¸Šï¼Œinterruptå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶ä¸”ç»“æŸé—²ç½®çš„çº¿ç¨‹ï¼Œå½“çº¿ç¨‹æ•°ä¸º0çš„æ—¶å€™å¯ä»¥åˆ‡æ¢åˆ°TIDYING</li>
<li>TIDYINGï¼šæ¸…ç†çŠ¶æ€ï¼Œåœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ä¼šæ‰§è¡Œterminatedï¼Œterminatedæ˜¯é»˜è®¤çš„ç©ºæ–¹æ³•ï¼Œå¯ä»¥ç»§æ‰¿ThreadPoolFactoryæ¥å®ç°</li>
<li>TERMINATEDï¼šç»ˆæ­¢çŠ¶æ€ï¼Œæ‰§è¡Œå®ŒtryTerminate()æ–¹æ³•</li>
</ol>
<h2 id="execute-æ–¹æ³•åˆ†æ"><a href="#execute-æ–¹æ³•åˆ†æ" class="headerlink" title="execute()æ–¹æ³•åˆ†æ"></a>execute()æ–¹æ³•åˆ†æ</h2><pre><code class="hljs undefined"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span>(<span class="hljs-params">Runnable command</span>)</span> &#123;
    <span class="hljs-keyword">if</span> (command == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();
    <span class="hljs-comment">//è·å–å½“å‰ctl    </span>
    <span class="hljs-keyword">int</span> c = ctl.<span class="hljs-keyword">get</span>();
    <span class="hljs-comment">//è·å–çº¿ç¨‹æ•°é‡ï¼Œåˆ¤æ–­æ˜¯å¦å°äºæ ¸å¿ƒçº¿ç¨‹æ•° </span>
    <span class="hljs-keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;
        <span class="hljs-comment">//æ‰§è¡ŒaddWorker</span>
        <span class="hljs-keyword">if</span> (addWorker(command, <span class="hljs-literal">true</span>))
            <span class="hljs-keyword">return</span>;
        c = ctl.<span class="hljs-keyword">get</span>();
    &#125;
    <span class="hljs-comment">//å¦‚æœå½“å‰çº¿ç¨‹æ± æ­£åœ¨è¿è¡Œåˆ™offerä¸€ä¸ªä»»åŠ¡ï¼ˆä½†æ˜¯å¯èƒ½ä¼šå¤±è´¥ï¼Œç«‹å³è¿”å›ç»“æœï¼‰</span>
    <span class="hljs-keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;
        <span class="hljs-comment">//é‡æ–°æ£€æŸ¥ctl</span>
        <span class="hljs-keyword">int</span> recheck = ctl.<span class="hljs-keyword">get</span>();
        <span class="hljs-comment">//å¦‚æœçº¿ç¨‹æ± ä¸åœ¨è¿è¡Œå°±æŠŠä»»åŠ¡remove</span>
        <span class="hljs-keyword">if</span> (! isRunning(recheck) &amp;&amp; <span class="hljs-keyword">remove</span>(command))
            <span class="hljs-comment">//è°ƒç”¨æ‹’ç»ç­–ç•¥</span>
            reject(command);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (workerCountOf(recheck) == <span class="hljs-number">0</span>)
            <span class="hljs-comment">//æ·»åŠ worker</span>
            addWorker(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
    &#125;
    <span class="hljs-comment">//æ·»åŠ workerå¤±è´¥åˆ™æ‹’ç»ä»»åŠ¡</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!addWorker(command, <span class="hljs-literal">false</span>))
        reject(command);
&#125;</code></pre>

<p>å…³äºctlçš„æ–¹æ³•å¯ä»¥é€šè¿‡çœ‹æ–¹æ³•åå­—æ¥äº†è§£æ„ä¹‰</p>
<p>å¤§è‡´æ‰§è¡Œæµç¨‹ï¼š</p>
<ol>
<li>éœ€è¦çº¿ç¨‹æ± æ¥æ‰§è¡Œä»»åŠ¡è°ƒç”¨äº†æ‰§è¡Œæ–¹æ³•ï¼Œå°±æ˜¯è°ƒç”¨äº†executeæˆ–è€…submit</li>
<li>çœ‹çœ‹çº¿ç¨‹æ•°é‡å¤Ÿä¸å¤Ÿè®¾å®šçš„corePoolSize</li>
<li>ä¸å¤Ÿå°±æ·»åŠ ï¼Œå¤Ÿå°±çœ‹çœ‹çº¿ç¨‹æ± æ˜¯ä¸æ˜¯è¿˜åœ¨è¿è¡Œï¼Œç„¶åç›´æ¥æ·»åŠ ä»»åŠ¡åˆ°é˜»å¡é˜Ÿåˆ—</li>
<li>æ·»åŠ æˆåŠŸæ—¶äºŒæ¬¡æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯è¿è¡Œå°±è¦åˆ æ‰åˆšåˆšæ·»åŠ çš„ä»»åŠ¡å¹¶ä¸”è¿˜ä¼šå°è¯•å…³é—­çº¿ç¨‹æ± ï¼Œè¿˜åœ¨è¿è¡Œå°±çœ‹çœ‹WorkerCountå¦‚æœæ˜¯0å°±æ·»åŠ éæ ¸å¿ƒçº¿ç¨‹</li>
<li>å¦‚æœå‰é¢æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ï¼Œä½†æ˜¯ä»»åŠ¡å¯¹æµå·²ç»æ»¡äº†ï¼Œå°±ç›´æ¥æ·»åŠ ä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹æ¥ç›´æ¥å¤„ç†è¿™ä¸ªä»»åŠ¡ï¼Œè¿™æ­¥ä¹Ÿå¤±è´¥äº†å°±è¯´æ˜å½“å‰çº¿ç¨‹æ•°è¾¾åˆ°ä¸Šé™äº†ï¼Œè¿™ä¸ªä»»åŠ¡åšä¸äº†ï¼Œéœ€è¦é€šè¿‡æ‹’ç»ç­–ç•¥æ¥æ‹’ç»</li>
</ol>
<h2 id="addWorker-æ–¹æ³•åˆ†æ"><a href="#addWorker-æ–¹æ³•åˆ†æ" class="headerlink" title="addWorker()æ–¹æ³•åˆ†æ"></a>addWorker()æ–¹æ³•åˆ†æ</h2><p>addWorkerçš„ä»£ç æ¯”è¾ƒé•¿ï¼Œä»ä¸Šé¢executeçš„æ‰§è¡Œæµç¨‹æ¥çœ‹ï¼Œéƒ½æ²¡æ€ä¹ˆå¯¹çº¿ç¨‹æ± çŠ¶æ€åšæ ¡éªŒï¼ˆåªæ˜¯åˆ¤æ–­äº†æ˜¯å¦æ˜¯RUNNINGçŠ¶æ€ï¼‰ï¼Œä¹Ÿæ²¡æœ‰å¯¹çº¿ç¨‹ä¸­çº¿ç¨‹æ•°é‡åšæ ¡éªŒï¼ˆå¦‚æœè¶…è¿‡äº†æŒ‡å®šçš„æœ€å¤§çº¿ç¨‹æ•°æˆ–è€…æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œäº†addWorkerï¼‰ï¼Œè¿™äº›åˆ¤æ–­éƒ½ä¼šåœ¨addWorkerä¸­ï¼Œé‚£ä¹ˆaddWorkerçš„ä¸»è¦åŠŸèƒ½å¤§æ¦‚çŒœæµ‹ä¸€ä¸‹å°±æ˜¯ï¼š</p>
<ul>
<li>æ ¡éªŒçº¿ç¨‹æ± çŠ¶æ€</li>
<li>æ ¡éªŒå½“å‰çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡æ˜¯å¦è¶…è¿‡æœ€å¤§å€¼</li>
<li>æ·»åŠ æ ¸å¿ƒæˆ–è€…éæ ¸å¿ƒçº¿ç¨‹</li>
</ul>
<p>addWorkeræ–¹æ³•æ¯”è¾ƒé•¿ï¼Œåˆ†æˆä¸¤å—ï¼Œå¯ä»¥å¯¹ç…§ç€ä»£ç ä¸€èµ·çœ‹ï¼Œè¿™å—ä¸»è¦æ˜¯å¯¹çº¿ç¨‹æ± çš„RunStateå’ŒWorkerCountçš„æ ¡éªŒ</p>
<pre><code class="hljs undefined"><span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> addWorker(Runnable firstTask, <span class="hljs-built_in">boolean</span> core) &#123;
    <span class="hljs-comment">//retryæ ‡ç­¾</span>
    retry:
    <span class="hljs-comment">//è‡ªæ—‹    </span>
    <span class="hljs-keyword">for</span> (;;) &#123;
        <span class="hljs-built_in">int</span> c = ctl.<span class="hljs-built_in">get</span>();
        <span class="hljs-built_in">int</span> rs = runStateOf(c);

        <span class="hljs-comment">// Check if queue empty only if necessary.</span>
       <span class="hljs-comment">// è¿™é‡Œå…¶å®å°±æ˜¯ä¸å…è®¸addçº¿ç¨‹çš„æƒ…å†µã€‚é¦–å…ˆçº¿ç¨‹æ± è¦åœ¨SHUTDOWNä¹‹åçš„çŠ¶æ€ </span>
       <span class="hljs-comment">// ç„¶åçº¿ç¨‹æ± å¦‚æœåœ¨SHUTDOWNçŠ¶æ€å¹¶ä¸”æ²¡æœ‰firstTaskå¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—æ— æ•°æ®</span>
       <span class="hljs-comment">// è¿™ç§æƒ…å†µæ˜¯ä¸å…è®¸addWorkerçš„ï¼Œçº¿ç¨‹æ± å·²ç»å¤„äºå…³é—­çš„çŠ¶æ€</span>
       <span class="hljs-comment">// firstTask!=nullçš„æƒ…å†µåªæœ‰ä¸¤ç§ï¼Œ1.åœ¨æ ¸å¿ƒçº¿ç¨‹æ²¡è¾¾åˆ°è§„å®šæ•°æ—¶ï¼Œæ·»åŠ æ ¸å¿ƒçº¿ç¨‹</span>
       <span class="hljs-comment">// 2.åœ¨ä»»åŠ¡é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œæ·»åŠ éæ ¸å¿ƒçº¿ç¨‹ç›´æ¥å¤„ç†ä»»åŠ¡</span>
        <span class="hljs-keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;
            ! (rs == SHUTDOWN &amp;&amp;
               firstTask == <span class="hljs-keyword">null</span> &amp;&amp;
               ! workQueue.isEmpty()))
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

        <span class="hljs-keyword">for</span> (;;) &#123;
            <span class="hljs-built_in">int</span> wc = workerCountOf(c);
            <span class="hljs-comment">//åˆ¤æ–­çº¿ç¨‹æ•°é‡æ˜¯å¦è¶…è¿‡ä¸Šé™å’ŒæŒ‡å®šæ•°é‡</span>
            <span class="hljs-keyword">if</span> (wc &gt;= CAPACITY ||
                wc &gt;= (core ? corePoolSize : maximumPoolSize))
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
            <span class="hljs-comment">//casæ¥å¢åŠ wcçš„æ•°é‡ï¼ŒæˆåŠŸäº†æ‰èƒ½ä»retryæ ‡ç­¾çš„å¾ªç¯è·³å‡ºï¼Œæ‰§è¡Œå¦ä¸€å—</span>
            <span class="hljs-comment">//å°±ç®—å¹¶å‘è¯»åˆ°äº†åŒæ ·çš„wcï¼Œåœ¨casä¹Ÿåªä¼šæœ‰ä¸€ä¸ªæˆåŠŸ</span>
            <span class="hljs-comment">//çœŸæ­£æ‰§è¡Œaddçš„ä»£ç     </span>
            <span class="hljs-keyword">if</span> (compareAndIncrementWorkerCount(c))
                <span class="hljs-keyword">break</span> retry;
            c = ctl.<span class="hljs-built_in">get</span>();  <span class="hljs-comment">// Re-read ctl</span>
            <span class="hljs-comment">//caså¤±è´¥äº†ä»¥ååˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æœ‰æ²¡æœ‰å˜æ›´ï¼Œå˜æ›´äº†èµ°å¤–å¾ªç¯ï¼Œå¦åˆ™èµ°å†…å¾ªç¯</span>
            <span class="hljs-keyword">if</span> (runStateOf(c) != rs)
                <span class="hljs-keyword">continue</span> retry;
            <span class="hljs-comment">// else CAS failed due to workerCount change; retry inner loop</span>
        &#125;
    &#125;</code></pre>

<p>è¿™éƒ¨åˆ†ä»£ç æ¯”è¾ƒå¥½ç†è§£ï¼Œåˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€å’Œçº¿ç¨‹æ•°é‡æ¥å†³å®šèƒ½ä¸èƒ½æ·»åŠ çº¿ç¨‹ï¼Œå¦‚æœéœ€è¦æ·»åŠ çº¿ç¨‹ï¼Œå¾—è¦åœ¨casæˆåŠŸäº†ä»¥åè·³å‡ºretryå¾ªç¯æ‰å¯ä»¥çœŸæ­£çš„æ·»åŠ çº¿ç¨‹<br>æ¥ä¸‹æ¥å°±æ˜¯å¦ä¸€å—addWorkerçš„ä»£ç </p>
<pre><code class="hljs undefined"><span class="hljs-comment">//è®°å½•workeræ˜¯å¦å¯åŠ¨</span>
    <span class="hljs-built_in">boolean</span> workerStarted = <span class="hljs-keyword">false</span>;
    <span class="hljs-comment">//workeræ˜¯å¦addæˆåŠŸ</span>
    <span class="hljs-built_in">boolean</span> workerAdded = <span class="hljs-keyword">false</span>;
    Worker w = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//newäº†ä¸€ä¸ªworkerï¼Œworkeré‡Œé¢åŒ…å«äº†ä¸€ä¸ªfirstTaskå’Œä¸€ä¸ªç”±çº¿ç¨‹å·¥å‚åˆ›å»ºçš„æ–°çš„çº¿ç¨‹</span>
        w = <span class="hljs-keyword">new</span> Worker(firstTask);
        <span class="hljs-comment">//tå°±æ˜¯è¿™ä¸ªæ–°çš„çº¿ç¨‹</span>
        <span class="hljs-keyword">final</span> Thread t = w.thread;
        <span class="hljs-keyword">if</span> (t != <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;
            <span class="hljs-comment">//è·å–çº¿ç¨‹æ± çš„é”ï¼Œè·å–åˆ°äº†æ‰èƒ½æ›´æ–°workers</span>
            mainLock.lock();
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">// Recheck while holding lock.</span>
                <span class="hljs-comment">// Back out on ThreadFactory failure or if</span>
                <span class="hljs-comment">// shut down before lock acquired.</span>
                <span class="hljs-built_in">int</span> rs = runStateOf(ctl.<span class="hljs-built_in">get</span>());
                <span class="hljs-comment">//é‡æ–°æ ¡éªŒçŠ¶æ€ï¼Œrs==SHUTDOWNçš„æ—¶å€™åªæ˜¯ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œæ‰€ä»¥firstTask==nullçš„æ—¶å€™</span>
                <span class="hljs-comment">//è¿˜æ˜¯å¯ä»¥æ·»åŠ workerçš„</span>
                <span class="hljs-keyword">if</span> (rs &lt; SHUTDOWN ||
                    (rs == SHUTDOWN &amp;&amp; firstTask == <span class="hljs-keyword">null</span>)) &#123;
                    <span class="hljs-comment">//æœªå¯åŠ¨å‰çš„çº¿ç¨‹çŠ¶æ€ä¸èƒ½ä¸ºæ´»è·ƒçš„</span>
                    <span class="hljs-keyword">if</span> (t.isAlive()) <span class="hljs-comment">// precheck that t is startable</span>
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalThreadStateException();
                    <span class="hljs-comment">//workersåŒ…å«äº†æ‰€æœ‰çš„worker    </span>
                    workers.<span class="hljs-built_in">add</span>(w);
                    <span class="hljs-built_in">int</span> s = workers.<span class="hljs-built_in">size</span>();
                    <span class="hljs-keyword">if</span> (s &gt; largestPoolSize)
                        largestPoolSize = s;
                    workerAdded = <span class="hljs-keyword">true</span>;
                &#125;
            &#125; <span class="hljs-keyword">finally</span> &#123;
                mainLock.unlock();
            &#125;
            <span class="hljs-comment">//æ·»åŠ æˆåŠŸäº†ä»¥åéœ€è¦startçº¿ç¨‹</span>
            <span class="hljs-keyword">if</span> (workerAdded) &#123;
                t.start();
                workerStarted = <span class="hljs-keyword">true</span>;
            &#125;
        &#125;
    &#125; <span class="hljs-keyword">finally</span> &#123;
        <span class="hljs-comment">//å¯åŠ¨å¤±è´¥åˆ™å›æ»šä¹‹å‰addæ“ä½œæ”¹å˜çš„å€¼</span>
        <span class="hljs-keyword">if</span> (! workerStarted)
            addWorkerFailed(w);
    &#125;
    <span class="hljs-keyword">return</span> workerStarted;
&#125;</code></pre>

<p>è¿™æ®µä»£ç ä¹Ÿä¸éš¾ç†è§£ï¼Œå®ä¾‹äº†ä¸€ä¸ªWorkerï¼Œç„¶åè·å–çº¿ç¨‹æ± çš„é”ï¼Œè·å–é”çš„æ—¶å€™å¿…é¡»å¾—è¦é‡æ–°æ ¡éªŒï¼Œæˆ‘è®¤ä¸ºçš„é‡æ–°æ ¡éªŒçš„å¿…è¦æ€§ï¼ˆä½¿ç”¨çš„æ˜¯ReentrantLockçš„éå…¬å¹³é”ï¼Œå½“çº¿ç¨‹æ²¡æœ‰è·å–åˆ°é”çš„æ—¶å€™ä¼šåœ¨aqsçš„åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…å¹¶ä¸”è°ƒç”¨unparkè¿›è¡Œé˜»å¡ï¼Œç”±äºæ˜¯éå…¬å¹³é”ï¼Œæ‰€ä»¥åœ¨ç­‰å¾…çš„æ—¶å€™ï¼Œå¦‚æœæœ‰æ–°çš„çº¿ç¨‹éœ€è¦è·å–é”ï¼Œå°±ä¼šç›´æ¥å°è¯•è·å–é”ï¼Œè¿™ç§æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´åŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹è·å–åˆ°é”çš„æ—¶é—´æ¯”è¾ƒä¹…ï¼Œé‚£ä¹ˆæ­¤æ—¶å¯¹çŠ¶æ€å†æ¬¡æ ¡éªŒå°±å¾ˆæœ‰å¿…è¦äº†ï¼Œå› ä¸ºå¹¶ä¸æ¸…æ¥šåœ¨é˜»å¡åˆ°å”¤é†’çš„æœŸé—´ï¼Œè¿™ä¸ªçº¿ç¨‹æ± åšäº†ä»€ä¹ˆå˜åŒ–ï¼Œå°±åƒäººç¡ç€äº†é†’æ¥ä¸æ¸…æ¥šå‘ç”Ÿäº†ä»€ä¹ˆä¸€æ ·ï¼‰</p>
<h2 id="workerç±»åˆ†æ"><a href="#workerç±»åˆ†æ" class="headerlink" title="workerç±»åˆ†æ"></a>workerç±»åˆ†æ</h2><pre><code class="hljs undefined"><span class="hljs-comment">//ç»§æ‰¿äº†aqså’ŒRunnable</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Worker</span>
    <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueuedSynchronizer</span>
    <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span>
</span>&#123;
    <span class="hljs-keyword">final</span> Thread thread;
    <span class="hljs-comment">/** Initial task to run.  Possibly null. */</span>
    Runnable firstTask;
    <span class="hljs-comment">/** Per-thread task counter */</span>
    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">long</span> completedTasks;

    Worker(Runnable firstTask) &#123;
        <span class="hljs-comment">//é‡ç‚¹</span>
        <span class="hljs-comment">//è®¾ç½®æˆ-1ï¼Œå°±æ˜¯ä¸ºäº†é˜²æ­¢åœ¨workeråœ¨åˆšåˆšåˆå§‹åŒ–ä»¥åå°±è¢«interruptï¼ˆå…·ä½“åœ¨shutdownæ–¹æ³•ä¸­ï¼‰</span>
        setState(<span class="hljs-number">-1</span>); <span class="hljs-comment">// inhibit interrupts until runWorker</span>
        <span class="hljs-keyword">this</span>.firstTask = firstTask;
        <span class="hljs-comment">//è¿™ä¸ªçº¿ç¨‹å°±æ˜¯é€šè¿‡å·¥å‚åˆ›å»ºçš„çº¿ç¨‹</span>
        <span class="hljs-comment">//thisæ˜¯Runnableç±»å‹ï¼Œå®é™…ä¸Šå°±æ˜¯ç”Ÿæˆçš„threadæ¥æ‰§è¡Œthisçš„runæ–¹æ³•</span>
        <span class="hljs-keyword">this</span>.thread = getThreadFactory().newThread(<span class="hljs-keyword">this</span>);
    &#125;

    <span class="hljs-comment">/** Delegates main run loop to outer runWorker  */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-comment">//runæ–¹æ³•è·‘çš„å°±æ˜¯è¿™ä¸ªrunWorker</span>
        runWorker(<span class="hljs-keyword">this</span>);
    &#125;

    <span class="hljs-comment">// Lock methods</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// The value 0 represents the unlocked state.</span>
    <span class="hljs-comment">// The value 1 represents the locked state.</span>
    <span class="hljs-comment">//ä¸‹é¢å°±æ˜¯å®ç°aqsçš„æ–¹æ³•äº†</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isHeldExclusively</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> getState() != <span class="hljs-number">0</span>;
    &#125;
    <span class="hljs-comment">//å®ç°äº†è·å–é”çš„æ–¹æ³•</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryAcquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> unused)</span> </span>&#123;
        <span class="hljs-comment">//casæ›´æ”¹çŠ¶æ€0â†’1</span>
        <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;
            setExclusiveOwnerThread(Thread.currentThread());
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    &#125;
    <span class="hljs-comment">//é‡Šæ”¾é”å°†çŠ¶æ€state=0</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryRelease</span><span class="hljs-params">(<span class="hljs-keyword">int</span> unused)</span> </span>&#123;
        setExclusiveOwnerThread(<span class="hljs-keyword">null</span>);
        setState(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span>        </span>&#123; acquire(<span class="hljs-number">1</span>); &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span>  </span>&#123; <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">tryAcquire</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>; &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span>      </span>&#123; release(<span class="hljs-number">1</span>); &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isLocked</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">isHeldExclusively</span><span class="hljs-params">()</span></span>; &#125;
    <span class="hljs-comment">//ä¸­æ–­å¯åŠ¨ä»¥åçš„çº¿ç¨‹</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">interruptIfStarted</span><span class="hljs-params">()</span> </span>&#123;
        Thread t;
        <span class="hljs-keyword">if</span> (getState() &gt;= <span class="hljs-number">0</span> &amp;&amp; (t = thread) != <span class="hljs-keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;
            <span class="hljs-keyword">try</span> &#123;
                t.interrupt();
            &#125; <span class="hljs-keyword">catch</span> (SecurityException ignore) &#123;
            &#125;
        &#125;
    &#125;
&#125;</code></pre>

<p>å®Œæ•´çš„workeræ–¹æ³•éƒ½åœ¨ä¸Šé¢äº†ï¼Œå…¶ä¸­æ¶‰åŠåˆ°äº†aqsçš„ç›¸å…³å†…å®¹ï¼Œç®€å•ç†è§£ä¸€ä¸‹ï¼Œlockå’Œunlockå°±æ˜¯é”å’Œé‡Šæ”¾é”çš„æ–¹æ³•ï¼Œå…¶ä¸­acquire(1)å’Œrelease(1)å°±æ˜¯æŒ‡çš„ï¼Œè·å–ä¸€æ¬¡é”å’Œé‡Šæ”¾ä¸€æ¬¡é”ï¼Œåœ¨workerä¸­ï¼Œé”æ˜¯ä¸å¯é‡å…¥é”ï¼ˆå°±æ˜¯é”åªæœ‰è·å–ä¸€æ¬¡ï¼Œä¸å¯èƒ½å†æ¬¡è·å–ï¼‰ï¼Œä¸ºä»€ä¹ˆè®¾ç½®ä¸ºä¸å¯é‡å…¥é”ï¼Ÿè¿™ä¸ªä¼šåœ¨åé¢åˆ†æã€‚</p>
<p>æ·»åŠ å®Œworkerä»¥åï¼Œçº¿ç¨‹æ˜¯æ€ä¹ˆæ‰§è¡Œé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å‘¢ï¼Œæˆ‘ä»¬çŸ¥é“çº¿ç¨‹æ‰§è¡Œçš„æ˜¯runæ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥çœ‹workerçš„runæ–¹æ³•ï¼Œåœ¨runæ–¹æ³•é‡Œé¢æ˜¯ç›´æ¥è°ƒç”¨äº†runWorker</p>
<h2 id="worker-runWorker-æ–¹æ³•åˆ†æ"><a href="#worker-runWorker-æ–¹æ³•åˆ†æ" class="headerlink" title="worker.runWorker()æ–¹æ³•åˆ†æ"></a>worker.runWorker()æ–¹æ³•åˆ†æ</h2><pre><code class="hljs undefined"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> runWorker(Worker w) &#123;
    Thread wt = Thread.currentThread();
    Runnable <span class="hljs-keyword">task</span> = w.firstTask;
    w.firstTask = <span class="hljs-keyword">null</span>;
    <span class="hljs-comment">//è°ƒç”¨äº†unlockï¼Œå°†workerä¸­çš„stateï¼š-1 -&gt; 0</span>
    w.unlock(); <span class="hljs-comment">// allow interrupts</span>
    <span class="hljs-comment">//çªç„¶å®Œæˆ</span>
    <span class="hljs-keyword">boolean</span> completedAbruptly = <span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//ä»»åŠ¡ä¸ä¸ºç©ºæˆ–è€…è·å–åˆ°çš„ä»»åŠ¡ä¸ä¸ºç©ºï¼ŒgetTaskæ˜¯ä¸ªé‡è¦çš„æ–¹æ³•</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">task</span> != <span class="hljs-keyword">null</span> || (<span class="hljs-keyword">task</span> = getTask()) != <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-comment">//é‡ç‚¹ï¼šè°ƒç”¨äº†lockï¼Œstate=0-&gt;1</span>
            w.lock();
            <span class="hljs-comment">// If pool is stopping, ensure thread is interrupted;</span>
            <span class="hljs-comment">// if not, ensure thread is not interrupted.  This</span>
            <span class="hljs-comment">// requires a recheck in second case to deal with</span>
            <span class="hljs-comment">// shutdownNow race while clearing interrupt</span>
            <span class="hljs-comment">//é‡æ–°æ ¡éªŒçŠ¶æ€</span>
            <span class="hljs-keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &amp;&amp;
                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;
                !wt.isInterrupted())
                wt.interrupt();
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">//æ‰§è¡Œå‰ç½®æ–¹æ³•ï¼Œé»˜è®¤ç©ºæ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿ThreadPoolExecutor</span>
                beforeExecute(wt, <span class="hljs-keyword">task</span>);
                Throwable thrown = <span class="hljs-keyword">null</span>;
                <span class="hljs-keyword">try</span> &#123;
                    <span class="hljs-comment">//è°ƒtaskçš„runæ–¹æ³•</span>
                    <span class="hljs-keyword">task</span>.run();
                &#125; <span class="hljs-keyword">catch</span> (RuntimeException x) &#123;
                    thrown = x; <span class="hljs-keyword">throw</span> x;
                &#125; <span class="hljs-keyword">catch</span> (Error x) &#123;
                    thrown = x; <span class="hljs-keyword">throw</span> x;
                &#125; <span class="hljs-keyword">catch</span> (Throwable x) &#123;
                    thrown = x; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(x);
                &#125; <span class="hljs-keyword">finally</span> &#123;
                    <span class="hljs-comment">//å’Œä¹‹å‰çš„beforeExecuteä¸€æ ·</span>
                    afterExecute(<span class="hljs-keyword">task</span>, thrown);
                &#125;
            &#125; <span class="hljs-keyword">finally</span> &#123;
                <span class="hljs-keyword">task</span> = <span class="hljs-keyword">null</span>;
                w.completedTasks++;
                <span class="hljs-comment">//å®Œæˆæ‰§è¡Œä»»åŠ¡åè§£é”ï¼Œstate=1-&gt;0</span>
                w.unlock();
            &#125;
        &#125;
        completedAbruptly = <span class="hljs-keyword">false</span>;
    &#125; <span class="hljs-keyword">finally</span> &#123;
        <span class="hljs-comment">//workerç»“æœåçš„å¤„ç†</span>
        processWorkerExit(w, completedAbruptly);
    &#125;
&#125;</code></pre>

<p>åœ¨runWorkeræ–¹æ³•é‡Œé¢æœ‰ä¸€ä¸ªwhileå¾ªç¯ï¼Œè¿™å°±æ˜¯çº¿ç¨‹å¤ç”¨çš„å®ç°ï¼Œé‚£ä¹ˆå¯ä»¥çŒœä¸€ä¸‹ï¼Œé˜»å¡é˜Ÿåˆ—çš„é˜»å¡å°±åœ¨getTaskæ–¹æ³•é‡Œé¢</p>
<p>runWorkeræ–¹æ³•å¤§è‡´å°±æ˜¯</p>
<ul>
<li>è·å–ä»»åŠ¡</li>
<li>æ£€æŸ¥çŠ¶æ€</li>
<li>æ‰§è¡Œä»»åŠ¡</li>
<li>ç»“æŸä»»åŠ¡å¤„ç†</li>
</ul>
<p>åœ¨çº¿ç¨‹è·å–åˆ°ä»»åŠ¡çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œlockï¼Œå¯èƒ½ä¼šæœ‰ç–‘æƒ‘ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦lockï¼Œå¹¶æ²¡æœ‰å¤šçº¿ç¨‹å¹¶å‘çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ</p>
<p>å…¶å®è¿™ä¸ªlockçš„ç”¨æ„å¹¶ä¸æ˜¯åœ¨äºé”çš„æ§åˆ¶ï¼Œè€Œæ˜¯æ¥åŒºåˆ«çº¿ç¨‹æ˜¯ç©ºé—²çš„ï¼ˆåœ¨é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„è¿‡ç¨‹ä¸­é˜»å¡ï¼‰è¿˜æ˜¯æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„ï¼Œè¿™ä¹Ÿæ˜¯è®¾ç½®æˆä¸å¯é‡å…¥çš„åŸå› ï¼Œå› ä¸ºåœ¨å…³é—­çº¿ç¨‹æ± çš„æ—¶å€™ä¼šå…³é—­ç©ºé—²çš„çº¿ç¨‹ï¼Œè¿™æ—¶å€™ä¼šå»å°è¯•lockï¼Œç”±äºæ˜¯ä¸å¯é‡å…¥ï¼Œæ‰€ä»¥åªä¼šå°†é‚£äº›lockæˆåŠŸçš„çº¿ç¨‹interruptï¼Œè¿™éƒ¨åˆ†åœ¨ç»ˆæ­¢çº¿ç¨‹æ± çš„æ—¶å€™ä¼šè¯¦ç»†åˆ†æã€‚</p>
<h2 id="getTask-æ–¹æ³•åˆ†æ"><a href="#getTask-æ–¹æ³•åˆ†æ" class="headerlink" title="getTask()æ–¹æ³•åˆ†æ"></a>getTask()æ–¹æ³•åˆ†æ</h2><pre><code class="hljs undefined"><span class="hljs-function"><span class="hljs-keyword">private</span> Runnable <span class="hljs-title">getTask</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-comment">//è®°å½•pollæ–¹æ³•æ˜¯å¦è¶…æ—¶</span>
    <span class="hljs-keyword">boolean</span> timedOut = <span class="hljs-keyword">false</span>; <span class="hljs-comment">// Did the last poll() time out?</span>

    <span class="hljs-keyword">for</span> (;;) &#123;
        <span class="hljs-keyword">int</span> c = ctl.get();
        <span class="hljs-keyword">int</span> rs = runStateOf(c);

        <span class="hljs-comment">// Check if queue empty only if necessary.</span>
        <span class="hljs-comment">//æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœæ˜¯SHUTDOWNå¹¶ä¸”é˜Ÿåˆ—ç©ºäº†å°±å¯ä»¥ç»“æŸå½“å‰çº¿ç¨‹</span>
        <span class="hljs-keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;
            decrementWorkerCount();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;

        <span class="hljs-keyword">int</span> wc = workerCountOf(c);

        <span class="hljs-comment">// Are workers subject to culling?</span>
        <span class="hljs-comment">//timedå…¶å®å°±æ˜¯æ—¶é—´æ˜¯å¦æœ‰æ•ˆçš„æ„æ€ï¼Œå¦‚æœå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶æˆ–è€…wcå¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°å°±æœ‰æ•ˆ</span>
        <span class="hljs-keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;
        <span class="hljs-comment">//wcå¤§äºæœ€å¤§çº¿ç¨‹æ•°æˆ–è€…è¶…æ—¶æœ‰æ•ˆå¹¶ä¸”è¶…æ—¶äº† ç„¶åè¿˜å‰©ä½™æœ‰çº¿ç¨‹æˆ–è€…æ²¡æœ‰ä»»åŠ¡äº†</span>
        <span class="hljs-keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))
            &amp;&amp; (wc &gt; <span class="hljs-number">1</span> || workQueue.isEmpty())) &#123;
            <span class="hljs-keyword">if</span> (compareAndDecrementWorkerCount(c))
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            <span class="hljs-comment">//caså¤±è´¥äº†è¯´æ˜æœ‰çº¿ç¨‹å·²ç»ä¿®æ”¹äº†ctlçš„å€¼</span>
            <span class="hljs-comment">//æ‰€ä»¥éœ€è¦é‡æ–°èµ°ä¸€æ¬¡å¾ªç¯ï¼Œå†æ¬¡è·å–ctlï¼Œé‡æ–°åˆ¤æ–­    </span>
            <span class="hljs-keyword">continue</span>;
        &#125;

        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//æ ¹æ®æ—¶é—´æ˜¯å¦æœ‰æ•ˆæ¥å†³å®šç”¨å“ªç§æ–¹å¼æ‹‰å–ä»»åŠ¡</span>
            Runnable r = timed ?
                <span class="hljs-comment">//è¶…æ—¶è¿”å›null</span>
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                <span class="hljs-comment">//å¦‚æœæ²¡æœ‰æ•°æ®åˆ™ä¼šé˜»å¡ï¼Œå¦åˆ™ç›´æ¥è¿”å›æ•°æ® </span>
                workQueue.take();
            <span class="hljs-keyword">if</span> (r != <span class="hljs-keyword">null</span>)
                <span class="hljs-keyword">return</span> r;
            timedOut = <span class="hljs-keyword">true</span>;
        &#125; <span class="hljs-keyword">catch</span> (InterruptedException retry) &#123;
            <span class="hljs-comment">//å¦‚æœæ•è·åˆ°äº†interruptedå¼‚å¸¸åˆ™ç½®ä¸ºfalseé‡èµ°å¾ªç¯</span>
            <span class="hljs-comment">//è¿™æ—¶å€™å¯èƒ½æ˜¯çº¿ç¨‹æ± å…³é—­äº†</span>
            timedOut = <span class="hljs-keyword">false</span>;
        &#125;
    &#125;
&#125;</code></pre>

<p>åˆ†æä¸€ä¸‹è¿™ä¸ªtimedå˜é‡çš„å–å€¼ï¼Œwc &gt; corePoolSizeï¼Œæ˜¯å¯èƒ½å­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°åŒæ ·çš„wcï¼Œç„¶ååŒæ—¶åˆ¤æ–­åˆ°è¿™ä¸€æ­¥çš„ï¼Œä½†æ˜¯è¿™é‡Œå€¼è¿›è¡Œäº†ä¸€æ¬¡casæ¥ä¿®æ”¹çº¿ç¨‹çš„æ•°é‡ï¼Œå¤šä¸ªçº¿ç¨‹æ“ä½œå¿…ç„¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹å°†ä¼šé‡æ–°å¼€å§‹å¾ªç¯ï¼Œå†æ¬¡è·å–ctlçš„å€¼æ¥å†æ¬¡åˆ¤æ–­ã€‚</p>
<p>timedçš„å€¼æ˜¯æ ¹æ®wcå’ŒcorePoolSizeçš„å…³ç³»å†³å®šçš„</p>
<ul>
<li>å½“å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶çš„æ—¶å€™ï¼Œè¿™ä¸ªçº¿ç¨‹æ± ä¸­æ ¸å¿ƒçº¿ç¨‹çš„æ¦‚å¿µå…¶å®å°±æ²¡æœ‰äº†ï¼Œä¸ä¼šæœ‰çº¿ç¨‹å¸¸é©»äº†</li>
<li>å½“wcè¿˜ä¸åˆ°corePoolSizeå°±æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡è¿˜ä¸å¤Ÿçš„æ—¶å€™timedæ˜¯ä¸ºfalseçš„ï¼Œä¹Ÿå°±æ˜¯æ—¶é—´æ— æ•ˆï¼Œè¿™æ—¶å€™timeOutä¼šå˜æˆtrueï¼Œå¼€å§‹é˜»å¡ç­‰å¾…ï¼Œæ‰€ä»¥æ ¸å¿ƒçº¿ç¨‹ä¼šåœ¨è¿™ä¸æ–­ç­‰å¾…ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œä½†æ˜¯ä»ä»£ç å¯ä»¥çœ‹å‡ºæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸æ˜¯æŒ‡çš„ç‰¹å®šçš„æŸä¸ªçº¿ç¨‹ï¼Œè€Œæ˜¯æŒ‡è¿™ä¸ªæ•°é‡</li>
<li>å½“wcå¤§äºcorePoolSizeçš„æ—¶å€™ï¼Œå¤§äºæ ¸å¿ƒæ•°é‡çš„çº¿ç¨‹åœ¨æŒ‡å®šæ—¶é—´å†…è·å–ä¸åˆ°ä»»åŠ¡å°±ä¼šå°†timeOutç½®ä¸ºtrueï¼Œç„¶åé‡æ–°èµ°ä¸€æ¬¡å¾ªç¯ï¼Œç„¶ååœ¨22è¡Œä»£ç å¤„è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¦ç»“æŸçº¿ç¨‹</li>
</ul>
<h2 id="processWorkerExit-æ–¹æ³•åˆ†æ"><a href="#processWorkerExit-æ–¹æ³•åˆ†æ" class="headerlink" title="processWorkerExit()æ–¹æ³•åˆ†æ"></a>processWorkerExit()æ–¹æ³•åˆ†æ</h2><p>processWorkerExit()æ–¹æ³•æ˜¯workerç»“æŸçš„æ—¶å€™æ‰§è¡Œçš„å¤„ç†</p>
<pre><code class="hljs undefined"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> processWorkerExit(Worker w, <span class="hljs-built_in">boolean</span> completedAbruptly) &#123;
    <span class="hljs-comment">//å¦‚æœæ˜¯çªç„¶å®Œæˆï¼Œåœ¨æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™å‡ºç°</span>
    <span class="hljs-keyword">if</span> (completedAbruptly) <span class="hljs-comment">// If abrupt, then workerCount wasn't adjusted</span>
        <span class="hljs-comment">//å‡å°‘worker</span>
        decrementWorkerCount();

    <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;
    mainLock.lock();
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//è®°å½•æ‰§è¡Œä»»åŠ¡çš„æ•°é‡</span>
        completedTaskCount += w.completedTasks;
        workers.remove(w);
    &#125; <span class="hljs-keyword">finally</span> &#123;
        mainLock.unlock();
    &#125;
    <span class="hljs-comment">//å°è¯•å…³é—­çº¿ç¨‹æ± ï¼Œä¼šæ ¹æ®çŠ¶æ€åˆ¤æ–­    </span>
    tryTerminate();

    <span class="hljs-built_in">int</span> c = ctl.<span class="hljs-built_in">get</span>();
    <span class="hljs-comment">//å¦‚æœçº¿ç¨‹æ± æ˜¯RUNNINGæˆ–è€…SHUTDOWN</span>
    <span class="hljs-keyword">if</span> (runStateLessThan(c, STOP)) &#123;
        <span class="hljs-keyword">if</span> (!completedAbruptly) &#123;
            <span class="hljs-comment">//minå½“å‰çº¿ç¨‹æ± å…è®¸çš„æœ€å°çº¿ç¨‹æ•°é‡</span>
            <span class="hljs-built_in">int</span> <span class="hljs-built_in">min</span> = allowCoreThreadTimeOut ? <span class="hljs-number">0</span> : corePoolSize;
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">min</span> == <span class="hljs-number">0</span> &amp;&amp; ! workQueue.isEmpty())
                <span class="hljs-comment">//å¦‚æœmin==0å¹¶ä¸”é˜»å¡é˜Ÿåˆ—è¿˜æœ‰æ•°æ®ï¼Œè‡³å°‘ç•™ä¸€ä¸ªçº¿ç¨‹</span>
                <span class="hljs-built_in">min</span> = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (workerCountOf(c) &gt;= <span class="hljs-built_in">min</span>)
                <span class="hljs-keyword">return</span>; <span class="hljs-comment">// replacement not needed</span>
        &#125;
        <span class="hljs-comment">//æ·»åŠ ä¸€ä¸ªçº¿ç¨‹</span>
        <span class="hljs-comment">//ä¸¤ç§æƒ…å†µ</span>
        <span class="hljs-comment">//completedAbruptly==true</span>
        <span class="hljs-comment">//wc &lt; minï¼Œçº¿ç¨‹ä¸å¤Ÿæ»¡è¶³è¦æ±‚å°±éœ€è¦æ·»åŠ ä¸€ä¸ª</span>
        addWorker(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);
    &#125;
&#125;</code></pre>

<p>å¯¹äºçº¿ç¨‹æ± çš„æ‰§è¡Œæµç¨‹ä»£ç åˆ†æçš„å·²ç»å·®ä¸å¤šäº†ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± çš„å…³é—­æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œæ€ä¹ˆæ ·æ‰èƒ½åˆé€‚çš„å…³é—­çº¿ç¨‹æ± ï¼Ÿ</p>
<h1 id="çº¿ç¨‹æ± çš„å…³é—­"><a href="#çº¿ç¨‹æ± çš„å…³é—­" class="headerlink" title="çº¿ç¨‹æ± çš„å…³é—­"></a>çº¿ç¨‹æ± çš„å…³é—­</h1><p>ç»å¸¸ä¼šä½¿ç”¨çš„å…³é—­æ–¹æ³•æœ‰shutdown()ï¼ŒshutdownNow()å’ŒawaitTermination()ï¼Œé€ä¸ªåˆ†æ</p>
<h2 id="shutdown-æ–¹æ³•åˆ†æ"><a href="#shutdown-æ–¹æ³•åˆ†æ" class="headerlink" title="shutdown()æ–¹æ³•åˆ†æ"></a>shutdown()æ–¹æ³•åˆ†æ</h2><pre><code class="hljs undefined"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;
    mainLock.lock();
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//æ£€æŸ¥æƒé™</span>
        checkShutdownAccess();
        <span class="hljs-comment">//å°†çŠ¶æ€è®¾ç½®æˆSHUTDOWNï¼Œé‡Œé¢æ˜¯ä¸ªå¾ªç¯cas</span>
        advanceRunState(SHUTDOWN);
        <span class="hljs-comment">//interruptç©ºé—²çš„çº¿ç¨‹</span>
        interruptIdleWorkers();
        <span class="hljs-comment">//è°ƒç”¨onShutDownæ–¹æ³•ï¼Œé»˜è®¤ç©ºæ–¹æ³•ï¼Œå¯ä»¥è‡ªå·±å®ç°</span>
        onShutdown(); <span class="hljs-comment">// hook for ScheduledThreadPoolExecutor</span>
    &#125; <span class="hljs-keyword">finally</span> &#123;
        mainLock.unlock();
    &#125;
    <span class="hljs-comment">//å°è¯•å…³é—­</span>
    tryTerminate();
&#125;</code></pre>

<p>åœ¨shutdownä¸­æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•interruptIdleWorkers()</p>
<h3 id="interruptIdleWorkers-æ–¹æ³•åˆ†æ"><a href="#interruptIdleWorkers-æ–¹æ³•åˆ†æ" class="headerlink" title="interruptIdleWorkers()æ–¹æ³•åˆ†æ"></a>interruptIdleWorkers()æ–¹æ³•åˆ†æ</h3><pre><code class="hljs undefined"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">interruptIdleWorkers</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> onlyOne)</span> </span>&#123;
    <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;
    mainLock.lock();
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//éå†æ‰€æœ‰workers</span>
        <span class="hljs-keyword">for</span> (Worker w : workers) &#123;
            Thread t = w.thread;
            <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦å·²ç»interruptedï¼Œå¹¶ä¸”å°è¯•è·å–é”</span>
            <span class="hljs-keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;
                <span class="hljs-keyword">try</span> &#123;
                    <span class="hljs-comment">//è·å–é”æˆåŠŸäº†å°±interrupt</span>
                    t.interrupt();
                &#125; <span class="hljs-keyword">catch</span> (SecurityException ignore) &#123;
                &#125; <span class="hljs-keyword">finally</span> &#123;
                    w.unlock();
                &#125;
            &#125;
            <span class="hljs-comment">//æ˜¯interruptå…¨éƒ¨è¿˜æ˜¯åªæ˜¯ä¸€ä¸ª</span>
            <span class="hljs-keyword">if</span> (onlyOne)
                <span class="hljs-keyword">break</span>;
        &#125;
    &#125; <span class="hljs-keyword">finally</span> &#123;
        mainLock.unlock();
    &#125;
&#125;</code></pre>

<p>ä¸Šè¿°è°ƒç”¨tryLockæ–¹æ³•æ¥å°è¯•è·å–é”ï¼Œå¯¹è·å–æˆåŠŸçš„çº¿ç¨‹æ‰§è¡Œinterruptï¼Œç»“åˆå‰é¢çš„runWorkerä¸€èµ·çœ‹</p>
<pre><code class="hljs undefined"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> runWorker(Worker w) &#123;
    Thread wt = Thread.currentThread();
    Runnable <span class="hljs-keyword">task</span> = w.firstTask;
    w.firstTask = <span class="hljs-keyword">null</span>;
    w.unlock(); <span class="hljs-comment">// allow interrupts</span>
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">task</span> != <span class="hljs-keyword">null</span> || (<span class="hljs-keyword">task</span> = getTask()) != <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-comment">//é‡ç‚¹ï¼šè°ƒç”¨äº†lockï¼Œstate=0â†’1</span>
            w.lock();
...
           w.unlock();
...
&#125;</code></pre>

<p>åœ¨runWorkerä¸­ï¼Œåœ¨è·å–åˆ°ä»»åŠ¡çš„æ—¶å€™ä¼šè¿›è¡Œlockï¼Œå°±æ˜¯åœ¨æ‰§è¡Œä»»åŠ¡çš„workerçš„state=1ï¼Œé‚£ä¹ˆåœ¨shutdownçš„æ—¶å€™ï¼Œä¼šéå†æ‰€æœ‰workersï¼Œè°ƒç”¨tryLockå°è¯•å°†workerçš„state=0â†’1ï¼Œå‰é¢ä¹Ÿè¯´äº†æ˜¯ä¸å¯é‡å…¥çš„é”ï¼Œæ‰€ä»¥åœ¨shutdownæ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œåœ¨runWorkerä¸­ï¼Œåªæœ‰æ­£åœ¨ä»é˜»å¡é˜Ÿåˆ—è·å–æ•°æ®ä½†æ˜¯è¿˜æœªè·å–åˆ°çš„ç©ºé—²çº¿ç¨‹ä¼šåœ¨shutdownçš„æ—¶å€™æˆåŠŸè·å–åˆ°é”ï¼Œç„¶åæ‰§è¡Œinterruptã€‚</p>
<p>æ‰€ä»¥åœ¨çº¿ç¨‹æ± å¤„äºSHUTDOWNçŠ¶æ€çš„æ—¶å€™ï¼Œå½“å‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ä¸ä¼šè¢«interrupt</p>
<p>++æ³¨æ„ï¼šinterruptä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸ä¼šç»ˆæ­¢çº¿ç¨‹ï¼Œåªæ˜¯ç»™çº¿ç¨‹æ‰“äº†ä¸€ä¸ªæ ‡å¿—ï¼Œæ ‡è®°è¿™ä¸ªçº¿ç¨‹interruptedçš„çŠ¶æ€æ˜¯trueï¼Œå¹¶ä¸”å½“è°ƒç”¨äº†Thread.interrupted()ä¹‹åä¼šå°†è¿™ä¸ªæ ‡è®°çŠ¶æ€æ¸…é™¤ï¼Œå¦‚æœä»£ç ä¸­ä¸æ£€æµ‹è¿™ä¸ªçŠ¶æ€ï¼Œé‚£ä¹ˆå°±ç®—è°ƒç”¨äº†interruptï¼Œçº¿ç¨‹ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆå½±å“++</p>
<p>æ‰€ä»¥ï¼Œåœ¨è°ƒç”¨äº†shutdownçš„æ—¶å€™ï¼Œåªæœ‰åœ¨getTaskçš„workeræ‰ä¼šè¢«interruptç»ˆæ­¢è·å–ä»»åŠ¡ï¼Œä½†æ˜¯ç»ˆæ­¢è·å–ä»»åŠ¡å¹¶æ²¡æœ‰ç«‹é©¬ç»“æŸå½“å‰çš„workerï¼Œè€Œæ˜¯ä¼šå†é‡æ–°å¾ªç¯è°ƒç”¨getTaskï¼Œè¿™æ—¶å€™ä¼šåˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ˜¯ä¸æ˜¯åœ¨SHUTDOWNä¹‹åï¼Œå¹¶ä¸”é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œæˆç«‹å°±ä¼šå°†å½“å‰workerç»“æŸã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š</p>
<ul>
<li>è°ƒç”¨äº†shutdown</li>
<li>çº¿ç¨‹æ± ä¸­ç­‰å¾…è·å–ä»»åŠ¡çš„workerä¼šè¢«interruptedï¼Œè·å–ä»»åŠ¡æœ‰ä¸¤ç§æƒ…å†µ<ul>
<li>ä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æ•°æ®ï¼Œé˜»å¡ç­‰å¾…æ•°æ®ï¼Œè¿™ç§ä¼šç›´æ¥è¢«interrupted</li>
<li>ä»»åŠ¡é˜Ÿåˆ—ä¸­è¿˜æœ‰æ•°æ®ï¼Œworkerä¼šä¸€ç›´å¤„ç†ç›´åˆ°queue==nullä¸ºæ­¢</li>
</ul>
</li>
<li>ä¸€æ—¦queue==nullï¼Œçº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWN</li>
<li>åœ¨getTaskæ–¹æ³•ä¸­decrease å½“å‰çš„workerCountï¼Œç„¶ågetTaskè¿”å›nullï¼Œç»ˆæ­¢å½“å‰worker</li>
<li>åœ¨executeæ–¹æ³•ï¼Œä¼šåˆ¤æ–­ä¸€äº›çŠ¶æ€ï¼Œç„¶åæ‹’ç»æ–°çš„ä»»åŠ¡ï¼Œå¯ä»¥è‡ªå·±çœ‹ä¸€ä¸‹å…·ä½“ä»£ç å®ç°</li>
</ul>
<p>åœ¨å¤„ç†workerå…³é—­çš„æ—¶å€™ç”¨äº†aqsæ¥åŒºåˆ«æ‰§è¡ŒçŠ¶æ€å’Œä»queueä¸­è·å–æ•°æ®çš„çŠ¶æ€</p>
<h2 id="shutdownNow-æ–¹æ³•åˆ†æ"><a href="#shutdownNow-æ–¹æ³•åˆ†æ" class="headerlink" title="shutdownNow()æ–¹æ³•åˆ†æ"></a>shutdownNow()æ–¹æ³•åˆ†æ</h2><pre><code class="hljs undefined"><span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Runnable&gt; <span class="hljs-title">shutdownNow</span>(<span class="hljs-params"></span>)</span> &#123;
    List&lt;Runnable&gt; tasks;
    final ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;
    mainLock.<span class="hljs-keyword">lock</span>();
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//è¿™å‡ è¡Œå’ŒShutDownç±»ä¼¼</span>
        checkShutdownAccess();
        advanceRunState(STOP);
        interruptWorkers();
        <span class="hljs-comment">//æ¸…ç©ºæ‰€æœ‰tasks</span>
        tasks = drainQueue();
    &#125; <span class="hljs-keyword">finally</span> &#123;
        mainLock.unlock();
    &#125;
    tryTerminate();
    <span class="hljs-keyword">return</span> tasks;
&#125;

<span class="hljs-comment">//ä¸­æ–­workers</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">interruptWorkers</span>(<span class="hljs-params"></span>)</span> &#123;
    final ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;
    mainLock.<span class="hljs-keyword">lock</span>();
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//ç›´æ¥ä¸­æ–­æ‰€æœ‰workers</span>
        <span class="hljs-keyword">for</span> (Worker w : workers)
            w.interruptIfStarted();
    &#125; <span class="hljs-keyword">finally</span> &#123;
        mainLock.unlock();
    &#125;
&#125;
<span class="hljs-comment">//ä¸­æ–­æ‰€æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„worker</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">interruptIfStarted</span>(<span class="hljs-params"></span>)</span> &#123;
    Thread t;
    <span class="hljs-comment">//æ­£åœ¨æ‰§è¡Œä¸­çš„workerä¸€å®šæ˜¯å·²ç»è°ƒç”¨äº†lockçš„ï¼Œé‚£ä¹ˆå¯¹åº”çš„state=1</span>
    <span class="hljs-keyword">if</span> (getState() &gt;= <span class="hljs-number">0</span> &amp;&amp; (t = thread) != <span class="hljs-literal">null</span> &amp;&amp; !t.isInterrupted()) &#123;
        <span class="hljs-keyword">try</span> &#123;
            t.interrupt();
        &#125; <span class="hljs-keyword">catch</span> (SecurityException ignore) &#123;
        &#125;
    &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;Runnable&gt; <span class="hljs-title">drainQueue</span>(<span class="hljs-params"></span>)</span> &#123;
    BlockingQueue&lt;Runnable&gt; q = workQueue;
    ArrayList&lt;Runnable&gt; taskList = <span class="hljs-keyword">new</span> ArrayList&lt;Runnable&gt;();
    <span class="hljs-comment">//æŠŠqueueä¸­çš„ä»»åŠ¡å…¨éƒ¨ç§»åˆ°å¦ä¸€ä¸ªlistä¸­</span>
    q.drainTo(taskList);
    <span class="hljs-comment">//éƒ¨åˆ†BlockingQueueå¯èƒ½ä¼šå¤±è´¥</span>
    <span class="hljs-keyword">if</span> (!q.isEmpty()) &#123;
        <span class="hljs-comment">//toArrayæ–¹æ³•æŒ‡å®šäº†Runnableç±»å‹</span>
        <span class="hljs-keyword">for</span> (Runnable r : q.toArray(<span class="hljs-keyword">new</span> Runnable[<span class="hljs-number">0</span>])) &#123;
            <span class="hljs-keyword">if</span> (q.<span class="hljs-keyword">remove</span>(r))
                taskList.<span class="hljs-keyword">add</span>(r);
        &#125;
    &#125;
    <span class="hljs-keyword">return</span> taskList;
&#125;</code></pre>

<p>ç›´æ¥åœ¨æ–¹æ³•ä¸­å°†ä»»åŠ¡queueä¸­çš„å‰©ä½™æœªå¤„ç†çš„ä»»åŠ¡å…¨éƒ¨æ¸…ç©ºå¹¶ä¸”è¿”å›å‡ºæ¥ï¼Œå¹¶ä¸”å°†æ­£åœ¨æ‰§è¡Œçš„worker ä¸­æ–­</p>
<p>ç„¶åå†çœ‹ä¸€ä¸‹tryTerminateåšäº†ä»€ä¹ˆï¼ŒtryTerminateæ–¹æ³•åœ¨ä¸¤ç§å…³é—­çº¿ç¨‹æ± çš„æ–¹æ³•ä¸­éƒ½æœ‰è°ƒç”¨</p>
<h2 id="tryTerminate-æ–¹æ³•åˆ†æ"><a href="#tryTerminate-æ–¹æ³•åˆ†æ" class="headerlink" title="tryTerminate()æ–¹æ³•åˆ†æ"></a>tryTerminate()æ–¹æ³•åˆ†æ</h2><pre><code class="hljs undefined"><span class="hljs-comment">//è¿™ä¸ªæ–¹æ³•ä¼šåœ¨ä»»ä½•å¯èƒ½ç»ˆæ­¢çº¿ç¨‹æ± çš„æ“ä½œé‡Œè¢«è°ƒç”¨</span>
<span class="hljs-comment">//æ¯”å¦‚ï¼šå‡å°‘worker countï¼Œåœ¨shutdownçŠ¶æ€remove taskï¼›</span>
<span class="hljs-keyword">final</span> void tryTerminate() &#123;
    <span class="hljs-keyword">for</span> (;;) &#123;
        int c = ctl.<span class="hljs-keyword">get</span>();
        <span class="hljs-keyword">if</span> (isRunning(c) ||
            runStateAtLeast(c, TIDYING) ||
            (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))
            <span class="hljs-keyword">return</span>;
        <span class="hljs-comment">//èƒ½é€šè¿‡ä¸Šé¢çš„åˆ¤æ–­è¯´æ˜çº¿ç¨‹æ± ç°åœ¨queueæ— æ•°æ®ï¼Œå¦‚æœæœ‰workeråˆ™åº”è¯¥ç»ˆæ­¢    </span>
        <span class="hljs-keyword">if</span> (workerCountOf(c) != <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// Eligible to terminate</span>
            interruptIdleWorkers(ONLY_ONE);
            <span class="hljs-keyword">return</span>;
        &#125;

        <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;
        mainLock.lock();
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//å°†ctl casè®¾ç½®ä¸ºTIDYING</span>
            <span class="hljs-keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="hljs-number">0</span>))) &#123;
                <span class="hljs-keyword">try</span> &#123;
                    <span class="hljs-comment">//é»˜è®¤ç©ºæ–¹æ³•</span>
                    terminated();
                &#125; <span class="hljs-keyword">finally</span> &#123;
                    <span class="hljs-comment">//æ‰§è¡Œå°†çŠ¶æ€å˜ä¸ºTERMINATED</span>
                    ctl.<span class="hljs-keyword">set</span>(ctlOf(TERMINATED, <span class="hljs-number">0</span>));
                    termination.signalAll();
                &#125;
                <span class="hljs-keyword">return</span>;
            &#125;
        &#125; <span class="hljs-keyword">finally</span> &#123;
            mainLock.unlock();
        &#125;
        <span class="hljs-comment">// else retry on failed CAS</span>
    &#125;
&#125;</code></pre>

<p>å¯¹äºçº¿ç¨‹æ± çš„å…³é—­</p>
<ul>
<li>è°ƒç”¨äº†shutdownï¼Œå°†çº¿ç¨‹æ± çŠ¶æ€ç½®ä¸ºSHUTDOWNï¼Œä¸ä¼šç«‹åˆ»å…³é—­ï¼Œä¼šç­‰å¾…queue==nullï¼Œç„¶åå°†workersç»“æŸï¼ŒæœŸé—´ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œé€šè¿‡æ‹’ç»ç­–ç•¥æ‹’ç»æ–°ä»»åŠ¡</li>
<li>è°ƒç”¨äº†shutdownNowï¼Œä¼šç«‹åˆ»æ¸…ç©ºqueueï¼Œå°†çº¿ç¨‹æ± çŠ¶æ€ç½®ä¸ºSTOPï¼Œå¹¶ä¸”å¼€å§‹ç»“æŸçº¿ç¨‹</li>
</ul>
<p>æ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦å¿«é€Ÿå“åº”å…³é—­çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨æ‰§è¡Œé€»è¾‘ä¸­æ£€æµ‹interruptedæ ‡å¿—åšç»“æŸå¤„ç†ï¼Œç„¶åè°ƒç”¨shutdownNowï¼Œå°±å¯ä»¥å¿«é€Ÿé€€å‡º</p>
<p>å½“æˆ‘ä»¬è°ƒç”¨shutdownçš„æ—¶å€™ï¼Œå¯èƒ½éœ€è¦ä¸€ä¼šå„¿æ‰èƒ½çœŸæ­£å°†çº¿ç¨‹æ± å…³é—­ï¼Œå› ä¸ºçº¿ç¨‹æ± éœ€è¦å°†queueä¸­çš„ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆæ‰ä¼šå¼€å§‹ç»“æŸçº¿ç¨‹</p>
<p>æ‰€ä»¥åœ¨ä»£ç ä¸­æ³¨é‡Šä¸­è¯´åˆ°</p>
<blockquote>
<pre><code>* &lt;p&gt;This method does not wait for previously submitted tasks to
* complete execution.  Use {@link #awaitTermination awaitTermination}
* to do that.</code></pre></blockquote>
<h2 id="awaitTermination-æ–¹æ³•åˆ†æ"><a href="#awaitTermination-æ–¹æ³•åˆ†æ" class="headerlink" title="awaitTermination()æ–¹æ³•åˆ†æ"></a>awaitTermination()æ–¹æ³•åˆ†æ</h2><pre><code class="hljs undefined"><span class="hljs-comment">//ç­‰å¾…æŒ‡å®šæ—¶é—´ç»“æŸ</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">awaitTermination</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span>
    <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
    <span class="hljs-keyword">long</span> nanos = unit.toNanos(timeout);
    <span class="hljs-keyword">final</span> ReentrantLock mainLock = <span class="hljs-keyword">this</span>.mainLock;
    mainLock.lock();
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-keyword">for</span> (;;) &#123;
            <span class="hljs-keyword">if</span> (runStateAtLeast(ctl.get(), TERMINATED))
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            <span class="hljs-keyword">if</span> (nanos &lt;= <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
            <span class="hljs-comment">//ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œæˆ–è€…è¢«signalå”¤èµ·æˆ–è€…è¢«interruptedä¸­æ–­    </span>
            nanos = termination.awaitNanos(nanos);
        &#125;
    &#125; <span class="hljs-keyword">finally</span> &#123;
        mainLock.unlock();
    &#125;
&#125;</code></pre>

<p>æ–¹æ³•è¿”å›booleanæ¥ç¡®å®šåœ¨æŒ‡å®šæ—¶é—´å†…çº¿ç¨‹æ± æ˜¯å¦çŠ¶æ€å˜æ›´ä¸ºTERMINATED</p>
<hr>
<p>é‚£ä¹ˆåœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å»å¯¹çº¿ç¨‹æ± çš„æ„é€ å‚æ•°è¿›è¡Œåˆé€‚çš„è®¾ç½®</p>
<h1 id="çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡çš„è®¾ç½®"><a href="#çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡çš„è®¾ç½®" class="headerlink" title="çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡çš„è®¾ç½®"></a>çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡çš„è®¾ç½®</h1><p>æ­£ç¡®çš„è®¾ç½®çº¿ç¨‹æ± çš„å¤§å°ï¼Œéœ€è¦åˆ†æè®¡ç®—ç¯å¢ƒï¼Œèµ„æºé¢„ç®—å’Œä»»åŠ¡çš„ç‰¹æ€§ã€‚</p>
<p>é¦–å…ˆç®€å•äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯CPUå¯†é›†å‹å’ŒIOå¯†é›†å‹</p>
<ul>
<li><p>CPUå¯†é›†å‹ï¼šCPUçš„å ç”¨å¾ˆé«˜ï¼ŒI/Oåœ¨çŸ­æ—¶é—´å†…å°±å¯ä»¥å®Œæˆï¼Œè€ŒCPUè¿˜æœ‰å¾ˆå¤šè¿ç®—è¦å¤„ç†ï¼ˆæ¯”å¦‚ä¸€ä¸ªåªæœ‰è®¡ç®—çš„åº”ç”¨ï¼Œå‡ ä¹éƒ½æ˜¯CPUè®¡ç®—ï¼Œä½†æ˜¯æ²¡æœ‰I/Oï¼‰</p>
<ul>
<li>ç‰¹ç‚¹ï¼šè¿›è¡Œå¤§é‡çš„è¿ç®—ï¼Œæ¶ˆè€—CPUèµ„æº</li>
</ul>
</li>
<li><p>IOå¯†é›†å‹ï¼šå¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾…I/Oçš„è¯»/å†™æ“ä½œï¼ŒCPUå ç”¨ä¸é«˜</p>
<ul>
<li>ç‰¹ç‚¹ï¼šCPUæ¶ˆè€—å°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…I/Oæ“ä½œçš„å®Œæˆ</li>
</ul>
</li>
</ul>
<h2 id="ã€ŠJAVAå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ä¸­ç»™å‡ºçš„æ–¹å¼"><a href="#ã€ŠJAVAå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ä¸­ç»™å‡ºçš„æ–¹å¼" class="headerlink" title="ã€ŠJAVAå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ä¸­ç»™å‡ºçš„æ–¹å¼"></a>ã€ŠJAVAå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ä¸­ç»™å‡ºçš„æ–¹å¼</h2><blockquote>
<p>å¯¹äºè®¡ç®—å¯†é›†çš„ä»»åŠ¡ï¼Œåœ¨æ‹¥æœ‰ N ä¸ªå¤„ç†å™¨çš„ç³»ç»Ÿä¸Šï¼Œå½“çº¿ç¨‹æ± å¤§å°ä¸º N+1 æ—¶ï¼Œé€šå¸¸èƒ½å®ç°æœ€ä¼˜çš„åˆ©ç”¨ç‡ã€‚ï¼ˆå³ä½¿å½“è®¡ç®—å¯†é›†å‹çš„çº¿ç¨‹å¶å°”ç”±äºé¡µç¼ºå¤±æ•…éšœæˆ–è€…å…¶å®ƒåŸå› è€Œæš‚åœæ—¶ï¼Œè¿™ä¸ªâ€œé¢å¤–â€çš„çº¿ç¨‹ä¹Ÿèƒ½ç¡®ä¿ CPU çš„æ—¶é’Ÿå‘¨æœŸä¸ä¼šè¢«æµªè´¹ã€‚ï¼‰å¯¹äºåŒ…å« I/O æ“ä½œæˆ–è€…å…¶å®ƒé˜»å¡æ“ä½œçš„ä»»åŠ¡ï¼Œç”±äºçº¿ç¨‹å¹¶ä¸ä¼šä¸€ç›´æ‰§è¡Œï¼Œå› æ­¤çº¿ç¨‹æ± çš„è§„æ¨¡åº”è¯¥æ›´å¤§ã€‚è¦æ­£ç¡®åœ°è®¾ç½®çº¿ç¨‹æ± çš„å¤§å°,ä½ å¿…é¡»ä¼°ç®—å‡ºä»»åŠ¡çš„ç­‰å¾…æ—¶é—´ä¸è®¡ç®—æ—¶é—´çš„æ¯”å€¼ã€‚è¿™ç§ä¼°ç®—ä¸éœ€è¦å¾ˆç²¾ç¡®,å¹¶ä¸”å¯ä»¥é€šè¿‡ä¸€äº›åˆ†ææˆ–ç›‘æ§å·¥å…·æ¥è·å¾—ã€‚ä½ è¿˜å¯ä»¥é€šè¿‡å¦ä¸€ç§æ–¹æ³•æ¥è°ƒèŠ‚çº¿ç¨‹æ± çš„å¤§å°:åœ¨æŸä¸ªåŸºå‡†è´Ÿè½½ä¸‹,åˆ†åˆ«è®¾ç½®ä¸åŒå¤§å°çš„çº¿ç¨‹æ± æ¥è¿è¡Œåº”ç”¨ç¨‹åº,å¹¶è§‚å¯ŸCPUåˆ©ç”¨ç‡çš„æ°´å¹³ã€‚<br>å¼•ç”¨è‡ªã€ŠJAVAå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ç¬¬å…«ç« çº¿ç¨‹æ± çš„ä½¿ç”¨-8.2è®¾ç½®çº¿ç¨‹æ± çš„å¤§å°</p>
</blockquote>
<p>ä¹¦ä¸­ç»™å‡ºå®šä¹‰ï¼š<br><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163839.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<p>ï¼ˆå…³äºçº¿ç¨‹æ± çš„å¤§å°å’Œé˜Ÿåˆ—å¤§å°ï¼Œç½‘ä¸Šå¯ä»¥æŸ¥åˆ°ä¸€ä¸ªä¼°ç®—ä»£ç ï¼‰</p>
<p>å¯¹äºå¹¶è¡Œå¸¦æ¥çš„ä¼˜åŒ–æ•ˆæœï¼Œå¯ä»¥é€šè¿‡ Amdahlå®šå¾‹æ¥è®¡ç®—</p>
<h2 id="Amdahlå®šå¾‹"><a href="#Amdahlå®šå¾‹" class="headerlink" title="Amdahlå®šå¾‹"></a>Amdahlå®šå¾‹</h2><p>é˜¿å§†è¾¾å°”å®šå¾‹ï¼šåœ¨å¢åŠ è®¡ç®—æœºèµ„æºçš„æƒ…å†µä¸‹ï¼Œç†è®ºä¸Šèƒ½å¤Ÿå®ç°çš„æœ€é«˜åŠ é€Ÿæ¯”ï¼Œè¿™ä¸ªå€¼å–å†³äºç¨‹åºä¸­å¯å¹¶è¡Œç»„ä»¶äºä¸²è¡Œç»„ä»¶æ‰€å çš„æ¯”é‡ã€‚<br><img src="https://hysnotepic.oss-cn-shanghai.aliyuncs.com/img/20191019163848.png" srcset="/crazy_ll/img/loading.gif" alt></p>
<blockquote>
<p>Få‡å®šæ˜¯å¿…é¡»è¢«ä¸²è¡Œæ‰§è¡Œçš„éƒ¨åˆ†ï¼ŒNè¡¨ç¤ºå¤„ç†å™¨æ•°é‡ã€‚å½“Nè¶‹äºæ— ç©·å¤§æ—¶ï¼Œæœ€å¤§çš„åŠ é€Ÿæ¯”è¶‹è¿‘ä¸1/Fã€‚<br>å¦‚æœç¨‹åºæœ‰50%çš„è®¡ç®—éœ€è¦ä¸²è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆæœ€å¤§åŠ é€Ÿæ¯”åªèƒ½æ˜¯2ã€‚åœ¨æ‹¥æœ‰10ä¸ªå¤„ç†å™¨çš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœæœ‰10%çš„éƒ¨åˆ†éœ€è¦ä¸²è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆæœ€é«˜åŠ é€Ÿæ¯”ä¸º5.3ï¼ˆ53%çš„ä½¿ç”¨ç‡ï¼‰ï¼Œåœ¨æ‹¥æœ‰100ä¸ªå¤„ç†å™¨çš„ç³»ç»Ÿä¸­ï¼ŒåŠ é€Ÿæ¯”è¾¾åˆ°9.2ï¼ˆ9%çš„ä½¿ç”¨ç‡ï¼‰ï¼Œå³ä½¿æœ‰æ— é™å¤šçš„CPUä¹Ÿä¸å¯èƒ½ä¸º10ã€‚</p>
</blockquote>
<hr>
<h1 id="ç»“å°¾"><a href="#ç»“å°¾" class="headerlink" title="ç»“å°¾"></a>ç»“å°¾</h1><p>è§£æäº†çº¿ç¨‹æ± ä¸­æ¯”è¾ƒæ ¸å¿ƒçš„æ–¹æ³•ï¼Œå¯¹äºå…¶ä½™çº¿ç¨‹æ± çš„æ–¹æ³•ï¼Œåœ¨ç†è§£äº†çº¿ç¨‹æ± çš„æ‰§è¡Œä»¥åå°±æ˜¾å¾—æ¯”è¾ƒç®€å•ï¼ŒJDKæä¾›çš„å‡ ç§çº¿ç¨‹æ± æ„é€ æ–¹æ³•ä¹Ÿå¯ä»¥è‡ªå·±åˆ†æä¸€ä¸‹ä¼˜ç¼ºç‚¹ï¼Œçº¿ç¨‹æ•°é…ç½®éœ€è¦å¤šæ–¹é¢çš„è€ƒé‡ã€‚</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/crazy_ll/categories/javaåŸºç¡€/">javaåŸºç¡€</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/crazy_ll/tags/åŸºç¡€/">åŸºç¡€</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/crazy_ll/2019/09/04/JVM/ç±»åŠ è½½å™¨ç†è§£andä¸€æ¬¡å®è·µä¸­çš„åº”ç”¨/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ç±»åŠ è½½å™¨ç†è§£&ä¸€æ¬¡å®è·µä¸­çš„åº”ç”¨</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/crazy_ll/2019/08/25/JVM/GCå…·ä½“è¿‡ç¨‹/">
                        <span class="hidden-mobile">GCè¿‡ç¨‹è¯¦è§£(OopMap,RememberSet)</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <script type="text/javascript">
    function loadUtterances() {
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'crazzyHY/blog-comment');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', 'github-light');
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    }
    waitElementVisible('comments', loadUtterances)
  </script>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/crazy_ll/js/debouncer.js" ></script>
<script  src="/crazy_ll/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/crazy_ll/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/crazy_ll/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "çº¿ç¨‹æ± å…¨è§£æ&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/crazy_ll/js/local-search.js" ></script>
  <script>
    var path = "/crazy_ll/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>

















  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?5b1a2b7048d7b2ca482bb0bcc0e2387e";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  

  





</body>
</html>
